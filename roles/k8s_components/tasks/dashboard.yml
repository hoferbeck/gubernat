- name: Create a directory for dashboard
  ansible.builtin.file:
    path: /opt/kubernetes/config/kubernetes-dashboard
    state: directory
    mode: '0755'
  register: dashboard_files

- name: Generate dashboard config on first master
  ansible.builtin.template:
    src: "{{ item }}"
    dest: /opt/kubernetes/config/kubernetes-dashboard/
  with_fileglob: ../templates/kubernetes-dashboard/*
  register: dashboard_files

- name: Install dashboard with kustomize
  ansible.builtin.command:
    cmd: kubectl apply -k /opt/kubernetes/config/kubernetes-dashboard/

- name: Copy get-dashboard-admin-token.sh script to /usr/local/sbin
  ansible.builtin.copy:
    src: roles/k8s_components/files/sbin/get-dashboard-admin-token.sh
    dest: /usr/local/sbin/get-dashboard-admin-token.sh
    owner: root
    group: root
    mode: 0o755
  when: (inventory_hostname in groups["master"]) and (dashboard_files is changed)

- name: Copy get-customer-token.sh script to /usr/local/bin
  ansible.builtin.copy:
    src: roles/k8s_components/files/get-customer-token.sh
    dest: /usr/local/bin/get-customer-token.sh
    owner: root
    group: root
    mode: 0o755
  when: (inventory_hostname in groups["master"]) and (dashboard_files is changed)